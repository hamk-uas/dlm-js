# GitHub Copilot instructions for dlm-js  

Purpose
- Help coding agents become productive immediately: what the project *is*, how it's built/tested, important conventions, and where to look for authoritative behavior.

High-level summary (big picture) üîé
- dlm-js is a computation-only TypeScript port of a MATLAB Dynamic Linear Model (DLM) using the `@jax-js-nonconsuming/jax` numeric backend. The library implements Kalman filter + RTS smoother and exposes CPU/WASM/WebGPU-capable implementations via `dlmFit`/`dlmSmo` (modes: `for`, `scan`, `jit`). `dlmgensys` generates G/F state-space matrices for polynomial trend, seasonal, and AR components.
- The authoritative numerical reference is generated by Octave (`tests/octave/niledemo.m`, `tests/octave/gensys_tests.m`) and compared in `tests/niledemo.test.ts` and `tests/gensys.test.ts`. Synthetic ground-truth tests in `tests/synthetic.test.ts` verify against mathematically known true states.

Quick start ‚Äî commands you will need (copy/paste) ‚ñ∂Ô∏è
- Install: `pnpm install`.
- Run node tests (uses source TS): `pnpm vitest run` or `pnpm run test:node`.
- Lint (jax-js-nonconsuming memory rules): `pnpm run lint`.
- Generate API docs: `pnpm run docs` (outputs to `docs/`, opens at `docs/index.html`).
- Generate Octave reference (requires `octave-cli`): `pnpm run test:octave` (produces `tests/niledemo-out-m.json`).
- Build for distribution: `pnpm run build`.
- Full CI-local check: `pnpm run test` (runs lint + Octave reference + Node tests).

Files & places to inspect first üìÅ
- Implementation: `src/index.ts` (Kalman filter + RTS smoother, modes, memory/dispose patterns, API signatures).
- State space generator: `src/dlmgensys.ts` (polynomial, seasonal, AR component assembly).
- Types & helpers: `src/types.ts` (TypedArray usage, `getFloatArrayType`).
- Test matrix: `tests/test-matrix.ts` (shared device √ó dtype configs and tolerances).
- Tests: `tests/niledemo.test.ts` (Nile demo vs Octave), `tests/gensys.test.ts` (multi-model vs Octave), `tests/synthetic.test.ts` (known true states, statistical assertions).
- Reference generators: `tests/octave/niledemo.m`, `tests/octave/gensys_tests.m` (MATLAB/Octave ground truth).
- Upstream issues: `issues/` (precision analysis filed to jax-js-nonconsuming).
- Build / CI hooks: `package.json`, `vite.config.ts`.

Project-specific conventions & gotchas ‚ö†Ô∏è
- Execution modes: `for` (fastest in interpreter), `scan` (enables JIT/AD), `jit` (jit(scan) ‚Äî fastest after compilation). Tests exercise all three ‚Äî any numeric change must pass all modes.
- Device/dtype behavior: tests pick backend automatically; `webgpu` ‚Üí float32 (more numeric drift), `wasm`/`cpu` ‚Üí float64 preferred for bit-for-bit checks. When debugging flakiness, force CPU + Float64.
- Reference-first testing: Octave output is the source of truth. If you change numerics intentionally, regenerate Octave output and update tests with justification.
- Partial-output testing: use `tests/niledemo-keys.json` to limit comparisons for partial implementations.
- Memory management: This project uses `@jax-js-nonconsuming/jax` which has **non-consuming ops** ‚Äî operations leave inputs intact. Use TC39 `using` keyword for automatic disposal and `tree.dispose()` for bulk cleanup. Do NOT use `.ref` (that is the consuming-ops pattern from a different fork).
- ESLint plugin: The `@jax-js-nonconsuming/eslint-plugin-jax-js` plugin enforces correct `using`/disposal patterns. **Always run `pnpm run lint` after editing `src/` files** to catch memory leaks, missing `using` declarations, and use-after-dispose bugs.
- Dependencies: Both `@jax-js-nonconsuming/jax` and its eslint plugin are installed from `github:hamk-uas/jax-js-nonconsuming`.

Testing & tolerance details (important for PRs) ‚úÖ
- **Three test suites**: `niledemo.test.ts` (8 tests, Nile data vs Octave), `gensys.test.ts` (30 tests, multi-model vs Octave), `synthetic.test.ts` (24 tests, known true states). Total: 62 tests.
- **Tolerances** are defined in `tests/test-matrix.ts`: Float64 relTol=2e-3, absTol=1e-6; Float32 relTol=1e-2, absTol=1e-4. The niledemo test uses tighter ~1e-10 relative tolerance for its specific comparison.
- Test artifacts: failing runs write `tests/out/` ‚Äî inspect JSON files there.
- When adding features: include tests that run in all three modes (`for`, `scan`, `jit`) and add keys to `niledemo-keys.json` if the change is a partial implementation.
- **Float32 + m > 2**: numerically unstable (covariance goes negative ‚Üí NaN). These combinations are skipped in both `gensys.test.ts` and `synthetic.test.ts`.
- **Leak detection**: Wrap jax-js-nonconsuming code in tests with `checkLeaks.start()` before and `checkLeaks.stop()` after to verify no `np.Array` objects are leaked. This catches missing `using`/`dispose` calls at runtime.
- **Eager-first development**: When writing new jax-js-nonconsuming code, always get it working in eager mode first (no `jit()` wrapper). Only wrap with `jit()` after the eager version is correct and leak-free. JIT adds tracing complexity that makes debugging harder.

Troubleshooting checklist (fast) ü©∫
- Deterministic mismatch? Re-run with CPU+Float64: tests set device via `defaultDevice('cpu')` and `DType.Float64` in the harness.
- Strange memory / nondeterminism? Ensure `using` declarations are present for all temporary `np.Array` values; run `pnpm run lint` to catch missing disposals.
- CI failure on Octave step? Install `octave-cli` locally and run `pnpm run test:octave` to reproduce.
- Want to inspect intermediate arrays? Look at `tests/out/*.json` produced by the test harness.

PR checklist (what an AI should do before opening a PR) üìã
1. Add/modify unit tests covering all modes: `for`, `scan`, `jit` (see `tests/niledemo.test.ts`).
2. If numeric behavior intentionally changes, update or regenerate Octave reference and explain reasoning in the PR description.
3. Update `tests/niledemo-keys.json` when exposing only a subset of outputs.
4. Ensure no new `np.Array` leaks ‚Äî use `using` for temporaries, `tree.dispose()` for bulk cleanup.
5. **Run `pnpm run lint`** to verify the jax-js-nonconsuming eslint plugin reports no memory/disposal issues.
6. Run: `pnpm install && pnpm vitest run && pnpm run test:octave` (if applicable).
7. If public API changes, update `README.md` and TypeScript types in `src/types.ts`.

Example prompts for agents (use these exact templates) ‚úçÔ∏è
- "Add `mode: 'vectorized'` to `dlmFit` implemented via a new helper in `src/index.ts`; add unit tests exercising the new mode and ensure existing `for`/`scan`/`jit` tests still pass. Update README and add entries to `tests/niledemo-keys.json` if output keys change."  
- "Fix a memory leak: find np.Array objects in `src/index.ts` not disposed in all branches and add `using`/`tree.dispose()` with a focused unit test using `checkLeaks.start()`/`.stop()` to verify."  
- "Investigate `jit` mismatch on WASM: run the `jit` test twice, capture `tests/out/niledemo-out-jit.json`, and produce a minimal reproducer that highlights the first differing tensor and its path." 

Where agents should open files first (order matters) ‚ñ∂Ô∏è
1. `tests/test-matrix.ts` (shared device √ó dtype configs, tolerances)
2. `tests/niledemo.test.ts` (Nile demo reference test)
3. `src/index.ts` (Kalman filter + RTS smoother, modes, dispose patterns)
4. `src/dlmgensys.ts` (state space generator)
5. `src/types.ts` (TypedArray shapes, helpers)
6. `tests/gensys.test.ts` (multi-model Octave reference tests)
7. `tests/synthetic.test.ts` (ground-truth tests with known true states)

Do not attempt to change (without explicit human approval) üö´
- The Octave reference generator in `tests/octave/` (numerical ground truth). Changes here must be accompanied by a justification and regression analysis.
- Public API shape in `dist/` or `types` unless a major version bump is planned.

Contact & follow-ups
- If anything in the instructions is unclear, ask which *behavior* or *test* to preserve ‚Äî provide the failing `tests/out/*.json` and the test name.